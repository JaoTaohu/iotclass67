# Analyze and make aggregations.
ในการวิเคราะห์และการทำการรวมข้อมูล (aggregations) จากข้อมูล IoT ข้อมูลที่ได้รับจากเซนเซอร์จะถูกส่งไปยังระบบประมวลผลแบบเรียลไทม์ เช่น Apache Flink หรือ Kafka Streams เพื่อตรวจจับแนวโน้ม วิเคราะห์รูปแบบ หรือคำนวณค่าเฉลี่ย ค่าสูงสุด-ต่ำสุด หรือการนับข้อมูล หลังจากนั้น ผลลัพธ์ที่ได้สามารถนำไปแสดงบนแดชบอร์ดหรือส่งต่อไปยังระบบอื่น ๆ เพื่อการตัดสินใจ ซึ่งช่วยให้การวิเคราะห์ข้อมูล IoT มีประสิทธิภาพและนำไปสู่การดำเนินการที่เหมาะสมได้



สถาปัตยกรรมที่อธิบายนี้เกี่ยวข้องกับการประมวลผลข้อมูลจากเซ็นเซอร์ที่รวบรวมผ่าน IoT โดยใช้ Kafka Streams โดยมีการพัฒนา microservice ที่ชื่อ IOT Processor ซึ่งทำหน้าที่ในการประมวลผลข้อมูลจาก sensor โดยประกอบด้วย processor สามตัว แต่ละตัวจะมีหน้าที่ในการทำการ aggregations (การรวมข้อมูลเพื่อคำนวณ) และแปลงข้อมูลเพื่อให้ได้ผลลัพธ์ที่มีความหมาย ซึ่งประกอบด้วยขั้นตอนดังนี้:

Aggregate Metrics By Sensor Processor:

ทำการรวมข้อมูลตาม sensor id ในช่วงเวลาหมุนเวียน 5 นาที (rotating time window) เพื่อคำนวณค่าเฉลี่ยของเซ็นเซอร์ เช่น อุณหภูมิ, ความชื้น, ความดัน, แสงสว่าง เป็นต้น
เมื่อหน้าต่างเวลาถูกปิด จะสร้างเรคอร์ดเดี่ยวที่มีข้อมูลรวมกว่า 300 รายการสำหรับแต่ละเซ็นเซอร์และค่าคำนวณค่าเฉลี่ย
ข้อมูลที่ประมวลผลนี้จะถูกเก็บใน Kafka topic ที่ชื่อว่า iot-aggregate-metrics-by-sensor
ต้องการ SerDe ที่เหมาะสมในการ serialize และ deserialize ข้อมูล
Aggregate Metrics By Place Processor:

ทำการรวมข้อมูลตาม place identifier แทนที่จะใช้ sensor id เพื่อคำนวณค่าเฉลี่ยตามตำแหน่ง
ข้อมูลที่สร้างจะมีโครงสร้าง schema ที่แตกต่างกันและจะถูกเก็บใน Kafka topic ที่ชื่อว่า iot-aggregate-metrics-place
จำเป็นต้องใช้ SerDe เพื่อ serialize ข้อมูลใน topic นี้
Prometheus-Compatible Processor:

ประมวลผลข้อมูลให้อยู่ในรูปแบบที่สอดคล้องกับ Prometheus โดยใช้ชื่อ, sensor id และ place identifier เป็น dimensions ของข้อมูล
payload จะเป็นค่าที่สามารถแสดงผลใน time series panels ใน Grafana
ข้อมูลนี้จะถูกเก็บใน Kafka topic ที่ชื่อว่า iot-metrics-time-series ซึ่ง Prometheus จะนำข้อมูลจาก topic นี้ไปดึงมาแสดงผล
สรุป: โครงสร้างนี้จะประมวลผลข้อมูลจากเซ็นเซอร์ในแบบ real-time โดยมีการคำนวณค่าเฉลี่ยและแปลงข้อมูลให้สามารถแสดงผลในระบบ monitoring (Prometheus, Grafana) เพื่อการวิเคราะห์เพิ่มเติมในลำดับถัดไป